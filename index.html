<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker镜像加速服务</title>
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/dqzboy/Blog-Image/BlogCourse/docker-proxy.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 复制 style.css 中的所有样式代码到这里 */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        .header {
            background-color: #333;
            color: #fff;
            padding: 10px 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo-link {
            display: flex;
            align-items: center;
        }

        .logo {
            height: 40px;
        }

        .nav-menu a {
            color: #fff;
            text-decoration: none;
            margin-left: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .page-title {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .page-subtitle {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
        }

        .tab-container {
            display: flex;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            background-color: #ddd;
            border: 1px solid #ccc;
            border-bottom: none;
        }

        .tab.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
        }

        .content {
            display: none;
            background-color: #fff;
            padding: 20px;
            border: 1px solid #ccc;
        }

        .content.active {
            display: block;
        }

        .input-group {
            display: flex;
            margin-bottom: 20px;
        }

        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-right: none;
        }

        .input-group button {
            padding: 10px;
            background-color: #333;
            color: #fff;
            border: 1px solid #333;
            cursor: pointer;
        }

        .features {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .feature-card {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            text-align: center;
        }

        .feature-card i {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .search-container {
            display: flex;
            margin-bottom: 20px;
        }

        .search-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-right: none;
        }

        .search-container button {
            padding: 10px;
            background-color: #333;
            color: #fff;
            border: 1px solid #333;
            cursor: pointer;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }

        .pagination-container button {
            padding: 10px;
            background-color: #333;
            color: #fff;
            border: 1px solid #333;
            cursor: pointer;
        }

        .pagination-container span {
            margin: 0 10px;
        }

        .image-tags-view {
            display: none;
        }

        .tag-header {
            margin-bottom: 20px;
        }

        .tag-breadcrumb a {
            color: #333;
            text-decoration: none;
        }

        .tag-search-container {
            display: flex;
            margin-bottom: 20px;
        }

        .tag-search-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-right: none;
        }

        .tag-search-container button {
            padding: 10px;
            background-color: #333;
            color: #fff;
            border: 1px solid #333;
            cursor: pointer;
        }

        .footer {
            background-color: #333;
            color: #fff;
            text-align: center;
            padding: 10px 0;
            margin-top: 20px;
        }

        .footer a {
            color: #fff;
            text-decoration: none;
        }

        .command-terminal {
            background-color: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .command-terminal .terminal-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 10px;
        }

        .command-terminal .terminal-button {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .command-terminal .button-red {
            background-color: #ff5f56;
        }

        .command-terminal .button-yellow {
            background-color: #ffbd2e;
        }

        .command-terminal .button-green {
            background-color: #27c93f;
        }

        .command-terminal pre {
            margin: 0;
        }

        .command-terminal .copy-btn {
            background-color: #444;
            color: #fff;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            margin-top: 10px;
        }

        .copy-success {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4caf50;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
        }

        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .toast-notification.error {
            background-color: #e74c3c;
        }

        .toast-notification.fade-out {
            opacity: 0;
        }

        .loading-indicator {
            text-align: center;
            padding: 20px;
        }

        .empty-result {
            text-align: center;
            padding: 20px;
        }

        .error-message {
            text-align: center;
            padding: 20px;
        }

        .retry-btn {
            background-color: #333;
            color: #fff;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
        }

        .tag-table-container {
            overflow-x: auto;
        }

        .tag-table {
            width: 100%;
            border-collapse: collapse;
        }

        .tag-table th, .tag-table td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
        }

        .tag-table th {
            background-color: #f4f4f4;
        }

        .tag-os-arch {
            display: flex;
            flex-wrap: wrap;
        }

        .tag-os-arch-item {
            background-color: #eee;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
        }

        .tag-os-arch-more {
            cursor: pointer;
            color: #007bff;
            margin: 5px;
        }

        .tag-os-arch-all {
            display: none;
            flex-wrap: wrap;
        }

        .tag-os-arch-all.show {
            display: flex;
        }

        .tag-search-stats {
            margin-bottom: 10px;
        }

        .tag-sort-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .tag-sort-container label {
            margin-right: 10px;
        }

        .tag-sort-container select {
            padding: 5px;
        }

        .no-filter-results {
            text-align: center;
            padding: 20px;
        }

        .message-container {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo-link">
                <img src="https://cdn.jsdelivr.net/gh/dqzboy/Blog-Image/BlogCourse/docker-proxy.png" alt="Logo" class="logo">
            </a>
            <nav class="nav-menu" id="navMenu">
                <!-- 菜单项通过 JavaScript 动态加载 -->
            </nav>
        </div>
    </header>

    <div class="container">
        <h1 class="page-title">Docker镜像加速服务</h1>
        <p class="page-subtitle">快速拉取 Docker 镜像，无需担心网络问题，轻松部署你的容器应用</p>
        
        <div class="tab-container">
            <div class="tab active" onclick="switchTab('accelerate')">
                <i class="fas fa-rocket"></i> 镜像加速
            </div>
            <div class="tab" onclick="switchTab('search')">
                <i class="fas fa-search"></i> 镜像搜索
            </div>
            <div class="tab" onclick="switchTab('documentation')">
                <i class="fas fa-book"></i> 使用教程
            </div>
        </div>

        <!-- 镜像加速内容 -->
        <div id="accelerateContent" class="content active">
            <div class="input-group">
                <input type="text" id="imageInput" 
                       placeholder="输入镜像名称，例如：nginx 或 mysql:5.7" 
                       onkeypress="if(event.key === 'Enter') generateCommands()" 
                       autofocus>
                <button onclick="generateCommands()">
                    <i class="fas fa-bolt"></i> 获取加速命令
                </button>
            </div>
            
            <div id="result" style="display:none;">
                <h2><i class="fas fa-terminal"></i> 加速命令</h2>
                <div id="commandsContainer"></div>
            </div>
            
            <div class="features">
                <div class="feature-card">
                    <i class="fas fa-tachometer-alt"></i>
                    <h3>高速拉取</h3>
                    <p>通过优化的代理网络，加速Docker镜像拉取</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-shield-alt"></i>
                    <h3>稳定可靠</h3>
                    <p>解决网络问题导致的拉取失败，提高部署成功率</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-magic"></i>
                    <h3>简单易用</h3>
                    <p>一键生成加速命令，无需复杂配置，立即开始使用</p>
                </div>
            </div>
        </div>

        <!-- 搜索内容 -->
        <div id="searchContent" class="content">
            <div class="search-container">
                <input type="text" id="searchInput" 
                       placeholder="输入关键词搜索Docker镜像，例如：nginx、mysql、redis..." 
                       onkeypress="if(event.key === 'Enter') searchDockerHub(1)">
                <button onclick="searchDockerHub(1)">
                    <i class="fas fa-search"></i> 搜索镜像
                </button>
            </div>
            
            <!-- 搜索结果容器 -->
            <div id="searchResultsContainer">
                <!-- 搜索结果列表 -->
                <div id="searchResultsList">
                    <div id="searchResults"></div>
                    
                    <!-- 分页控件 -->
                    <div class="pagination-container" id="paginationContainer" style="display: none;">
                        <button id="prevPageBtn" onclick="searchDockerHub(currentPage - 1)" disabled>
                            <i class="fas fa-chevron-left"></i> 上一页
                        </button>
                        <span id="pageInfo">第 1 页</span>
                        <button id="nextPageBtn" onclick="searchDockerHub(currentPage + 1)">
                            下一页 <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- 标签视图 -->
                <div id="imageTagsView" style="display: none;" class="image-tags-view">
                    <div class="tag-header">
                        <div class="tag-breadcrumb">
                            <a href="javascript:void(0);" onclick="showSearchResults()">返回搜索结果</a>
                        </div>
                        <h2 id="currentImageTitle"></h2>
                        <p id="imageDescription" class="image-description"></p>
                        <div class="image-meta">
                            <span id="imageStars"></span>
                            <span id="imagePulls"></span>
                        </div>
                    </div>
                    
                    <div class="tag-search-container">
                        <input type="text" id="tagSearchInput" placeholder="搜索TAG..." onkeyup="filterTags()">
                    </div>
                    
                    <div id="tagsResults"></div>
                    
                    <div class="pagination-container" id="tagPaginationContainer" style="display: none;">
                        <button id="tagPrevPageBtn" onclick="loadImageTags(currentTagPage - 1)" disabled>
                            <i class="fas fa-chevron-left"></i> 上一页
                        </button>
                        <span id="tagPageInfo">第 1 页</span>
                        <button id="tagNextPageBtn" onclick="loadImageTags(currentTagPage + 1)">
                            下一页 <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 底部特性说明 -->
            <div class="features">
                <div class="feature-card">
                    <i class="fas fa-search"></i>
                    <h3>快速搜索</h3>
                    <p>便捷地搜索Docker Hub上的所有可用镜像</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-tag"></i>
                    <h3>版本管理</h3>
                    <p>查看所有可用的镜像标签和版本信息</p>
                </div>
                <div class="feature-card">
                    <i class="fas fa-rocket"></i>
                    <h3>一键部署</h3>
                    <p>快速获取并使用所需的Docker镜像</p>
                </div>
            </div>
        </div>

        <!-- 文档内容 -->
        <div id="documentationContent" class="content">
            <div id="documentList"></div>
            <div id="documentationText"></div>
        </div>
    </div>

    <footer class="footer">
        <p>Copyright © <span id="currentYear"></span> <span class="copyright-text">Docker-Proxy</span> All Rights Reserved. <a href="https://github.com/dqzboy/Docker-Proxy" target="_blank">GitHub</a></p>
    </footer>

    <script>
        // 常量定义
        const proxyDomain = 'registry-cdn.example.com'; // 模拟的代理域名
        let currentPage = 1;
        let currentTagPage = 1;
        let currentImageData = null;

        // 配置数据模拟
        const config = {
            menuItems: [
                { text: 'GitHub', link: 'https://github.com/dqzboy/Docker-Proxy', newTab: true },
                { text: '文档', link: '#', newTab: false }
            ]
        };

        // 文档数据模拟 
        const mockDocuments = [
            {
                id: 1,
                title: "快速入门",
                content: "# 快速入门\n使用Docker镜像加速服务非常简单..."
            },
            {
                id: 2, 
                title: "配置说明",
                content: "# 配置说明\n详细的配置参数说明..."
            }
        ];

        // 搜索结果数据模拟
        const mockSearchResults = [
            {
                name: 'nginx',
                description: 'Official build of Nginx',
                is_official: true,
                star_count: 15000,
                pull_count: 1000000
            },
            {
                name: 'mysql',
                description: 'MySQL is a widely used, open-source relational database',
                is_official: true,
                star_count: 12000,
                pull_count: 900000
            }
        ];

        // 标签数据模拟 
        const mockTags = [
            {
                name: 'latest',
                last_updated: '2024-01-20T10:00:00Z',
                full_size: 150000000,
                images: [
                    { os: 'linux', architecture: 'amd64' },
                    { os: 'linux', architecture: 'arm64' }
                ]
            },
            {
                name: '1.24',
                last_updated: '2024-01-19T10:00:00Z',
                full_size: 145000000,
                images: [
                    { os: 'linux', architecture: 'amd64' }
                ]
            }
        ];

        // 生成加速命令
        function generateCommands(imageInput) {
            if (!imageInput) {
                imageInput = document.getElementById('imageInput').value.trim();
            }
            if (!imageInput) {
                alert('请输入 Docker 镜像名称');
                return;
            }
            let [imageName, tag] = imageInput.split(':');
            tag = tag || 'latest';
            
            let originalImage = `${imageName}:${tag}`;
            let proxyImage = '';
            if (!imageName.includes('/')) {
                proxyImage = `${proxyDomain}/library/${imageName}:${tag}`;
            } else {
                proxyImage = `${proxyDomain}/${imageName}:${tag}`;
            }
            
            const commands = [
                { title: "代理拉取镜像", cmd: `docker pull ${proxyImage}` },
                { title: "原始拉取命令", cmd: `docker pull ${originalImage}` },
                { title: "重命名镜像", cmd: `docker tag ${proxyImage} ${originalImage}` },
                { title: "删除代理镜像", cmd: `docker rmi ${proxyImage}` }
            ];
            
            const resultDiv = document.getElementById('result');
            const container = document.getElementById('commandsContainer');
            container.innerHTML = '';
            
            // 将生成的命令添加到结果容器中
            commands.forEach((command, index) => {
                const cmdDiv = document.createElement('div');
                cmdDiv.className = 'step';
                cmdDiv.innerHTML = `
                    <h3>${index + 1}. ${command.title}</h3>
                    <div class="command-terminal">
                        <div class="terminal-header">
                            <div class="terminal-button button-red"></div>
                            <div class="terminal-button button-yellow"></div>
                            <div class="terminal-button button-green"></div>
                        </div>
                        <pre><code>${command.cmd}</code>
                            <button class="copy-btn" onclick="copyToClipboard('${command.cmd}', this)">复制</button>
                        </pre>
                    </div>
                `;
                container.appendChild(cmdDiv);
            });

            // 显示结果并隐藏其他内容
            resultDiv.style.display = 'flex';
            resultDiv.style.flexDirection = 'column';
            document.querySelector('.quick-guide').style.display = 'none';
            document.querySelector('.features').style.display = 'none';
        }

        // 复制命令到剪贴板
        function copyToClipboard(text, element) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification();
                }, (err) => {
                    console.error('无法复制文本: ', err);
                });
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showNotification();
            }
        }

        function showNotification() {
            // 移除任何现有的通知
            const existingNotification = document.querySelector('.copy-success');
            if (existingNotification) {
                existingNotification.remove();
            }
            // 创建新的通知
            const successDiv = document.createElement('div');
            successDiv.className = 'copy-success';
            successDiv.textContent = '已复制到剪贴板';
            // 添加到body而不是pre元素
            document.body.appendChild(successDiv);
            // 1.5秒后移除提示
            setTimeout(() => {
                successDiv.remove();
            }, 1500);
        }

        // 修改后的搜索功能 - 使用模拟数据
        async function searchDockerHub(page = 1) {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) {
                showToast('请输入搜索关键词');
                return;
            }

            currentPage = page;
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '<div class="loading-indicator">正在搜索...</div>';
            searchResults.style.display = 'block';

            // 隐藏底部特性说明
            const features = document.querySelector('#searchContent .features');
            features.style.display = 'none';

            // 使用模拟数据
            setTimeout(() => {
                const filteredResults = mockSearchResults.filter(result => 
                    result.name.toLowerCase().includes(searchTerm.toLowerCase())
                );

                if (filteredResults.length > 0) {
                    searchResults.innerHTML = '';
                    const officialImages = filteredResults.filter(result => result.is_official);
                    const unofficialImages = filteredResults.filter(result => !result.is_official);

                    officialImages.forEach(result => {
                        searchResults.appendChild(createResultItem(result, true));
                    });

                    unofficialImages.forEach(result => {
                        searchResults.appendChild(createResultItem(result, false));
                    });

                    document.getElementById('paginationContainer').style.display = 'flex';
                } else {
                    searchResults.innerHTML = '<div class="empty-result"><i class="fas fa-search"></i><p>未找到匹配的镜像</p></div>';
                    document.getElementById('paginationContainer').style.display = 'none';
                }
            }, 500); // 模拟网络延迟
        }

        // 修改查看标签详情函数 - 使用模拟数据
        function viewImageDetails(imageName, isOfficial, description, stars, pulls) {
            currentImageData = {
                name: imageName,
                isOfficial: isOfficial,
                description: decodeURIComponent(description || ''),
                stars: stars,
                pulls: pulls
            };

            const imageTagsView = document.getElementById('imageTagsView');
            document.getElementById('searchResultsList').style.display = 'none';
            imageTagsView.style.display = 'block';

            // 使用模拟数据显示标签信息
            displayImageDetails();
        }

        // 新增：显示镜像详情函数
        function displayImageDetails() {
            const imageTagsView = document.getElementById('imageTagsView');
            imageTagsView.innerHTML = `
                <div class="tag-header">
                    <div class="tag-breadcrumb">
                        <a href="javascript:void(0);" onclick="showSearchResults()">返回搜索结果</a>
                    </div>
                    <h2 id="currentImageTitle">${currentImageData.name}</h2>
                    <p id="imageDescription" class="image-description">${currentImageData.description}</p>
                    <div class="image-meta">
                        <span><i class="fas fa-star"></i> ${formatNumber(currentImageData.stars)} 星标</span>
                        <span><i class="fas fa-download"></i> ${formatNumber(currentImageData.pulls)} 下载</span>
                    </div>
                </div>

                <div class="tag-actions">
                    <div class="tag-search-container">
                        <input type="text" id="tagSearchInput" placeholder="搜索TAG..." onkeyup="filterTags()">
                        <button class="search-btn" onclick="filterTags()">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                    <button id="loadAllTagsBtn" class="load-all-btn" onclick="loadAllTags()">
                        <i class="fas fa-cloud-download-alt"></i> 加载全部TAG
                    </button>
                </div>

                <div id="tagsResults"></div>
            `;

            // 显示模拟的标签数据
            displayTags(mockTags);
        }

        // 改进的API请求函数，支持自动重试
        async function fetchWithRetry(url, options = {}, retries = 3, retryDelay = 1000) {
            try {
                const response = await fetch(url, options);
                
                // 检查响应状态
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                
                // 检查内容类型
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error('服务器返回了非JSON格式的数据，请联系管理员');
                }
                
                return await response.json();
            } catch (error) {
                // 如果没有剩余重试次数，抛出异常
                if (retries <= 0) throw error;
                
                console.warn(`请求失败，将在${retryDelay}ms后重试 (剩余${retries}次): ${error.message}`);
                
                // 等待重试延迟
                await new Promise(resolve => setTimeout(resolve, retryDelay));
                
                // 递归重试，增加延迟时间
                return fetchWithRetry(url, options, retries - 1, retryDelay * 1.5);
            }
        }

        // 搜索功能 - 支持分页
        async function searchDockerHub(page = 1) {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) {
                showToast('请输入搜索关键词');
                return;
            }
            // 如果搜索词改变，重置为第1页
            if (currentSearchTerm !== searchTerm) {
                page = 1;
                currentSearchTerm = searchTerm;
            }

            currentPage = page;
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '<div class="loading-indicator">正在搜索...</div>';
            searchResults.style.display = 'block';  // 确保搜索结果可见
            // 隐藏底部特性说明
            const features = document.querySelector('#searchContent .features');
            features.style.display = 'none';

            // 当执行搜索时，确保返回到搜索结果列表视图
            document.getElementById('searchResultsList').style.display = 'block';
            document.getElementById('imageTagsView').style.display = 'none';

            try {
                // 使用新的fetchWithRetry函数
                const data = await fetchWithRetry(
                    `/api/dockerhub/search?term=${encodeURIComponent(searchTerm)}&page=${page}`
                );
                
                const results = data.results;
                const officialImages = results.filter(result => result.is_official);
                const unofficialImages = results.filter(result => !result.is_official)
                    .sort((a, b) => (b.star_count || 0) - (a.star_count || 0));
                const totalCount = data.count || 0;
                totalPages = Math.ceil(totalCount / 25);
                
                if (data.results && data.results.length > 0) {
                    searchResults.innerHTML = '';
                    officialImages.forEach(result => {
                        searchResults.appendChild(createResultItem(result, true));
                    });
                    unofficialImages.forEach(result => {
                        searchResults.appendChild(createResultItem(result, false));
                    });

                    updatePagination(page, totalPages);
                    document.getElementById('paginationContainer').style.display = 'flex';
                    
                } else {
                    searchResults.innerHTML = '<div class="empty-result"><i class="fas fa-search"></i><p>未找到匹配的镜像</p></div>';
                    document.getElementById('paginationContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('搜索出错:', error);
                searchResults.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>搜索时发生错误: ${error.message}</p>
                        <button onclick="searchDockerHub(${page})" class="retry-btn">
                            <i class="fas fa-redo"></i> 重试
                        </button>
                    </div>`;
                document.getElementById('paginationContainer').style.display = 'none';
            }
        }

        // 更新分页控件
        function updatePagination(currentPage, totalPages) {
            const paginationContainer = document.getElementById('paginationContainer');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const pageInfo = document.getElementById('pageInfo');
            
            // 显示分页控件
            paginationContainer.style.display = 'flex';
            // 更新页码信息
            pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
            
            // 根据当前页码禁用或启用上一页/下一页按钮
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }

        // 更新TAG分页控件
        function updateTagPagination(currentPage, totalPages) {
            const paginationContainer = document.getElementById('tagPaginationContainer');
            const prevBtn = document.getElementById('tagPrevPageBtn');
            const nextBtn = document.getElementById('tagNextPageBtn');
            const pageInfo = document.getElementById('tagPageInfo');
            
            // 显示分页控件
            paginationContainer.style.display = 'flex';
            // 更新页码信息
            pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
            
            // 根据当前页码禁用或启用上一页/下一页按钮
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
        }

        function createResultItem(result, isOfficial) {
            const resultItem = document.createElement('div');
            resultItem.className = `search-result-item ${isOfficial ? 'official-image' : ''}`;
            
            // 确保获取正确的描述字段 - 修复描述信息缺失问题
            const description = result.description || result.short_description || '暂无描述';
            
            resultItem.innerHTML = `
                <div class="result-header">
                    <div class="title-badge">
                        <h3>${result.name || result.repo_name || '未知名称'}</h3>
                        ${isOfficial ? '<span class="official-badge"><i class="fas fa-check-circle"></i> 官方</span>' : ''}
                    </div>
                    <div class="result-stats">
                        <span class="stats"><i class="fas fa-star"></i> ${formatNumber(result.star_count || 0)}</span>
                        <span class="stats"><i class="fas fa-download"></i> ${formatNumber(result.pull_count || 0)}</span>
                    </div>
                </div>
                <p class="result-description">${description}</p>
                <div class="result-actions">
                    <button class="action-btn primary" onclick="useImage('${result.name || result.repo_name}')">
                        <i class="fas fa-rocket"></i> 使用此镜像
                    </button>
                    <button class="action-btn secondary" onclick="viewImageDetails('${result.name || result.repo_name}', ${isOfficial}, '${encodeURIComponent(description)}', ${result.star_count || 0}, ${result.pull_count || 0})">
                        <i class="fas fa-tags"></i> 查看标签
                    </button>
                </div>
            `;
            return resultItem;
        }

        // 修改查看标签详情函数 - 改进错误处理
        async function viewImageDetails(imageName, isOfficial, description, stars, pulls) {
            // 保存当前镜像信息
            currentImageData = {
                name: imageName,
                isOfficial: isOfficial,
                description: decodeURIComponent(description || ''),
                stars: stars,
                pulls: pulls
            };
            
            // 显示加载中状态
            const imageTagsView = document.getElementById('imageTagsView');
            imageTagsView.innerHTML = '<div class="loading-container"><div class="loading-indicator">正在加载镜像信息...</div></div>';
            document.getElementById('searchResultsList').style.display = 'none';
            imageTagsView.style.display = 'block';
            
            try {
                // 使用新的fetchWithRetry函数获取标签计数
                const countApiUrl = `/api/dockerhub/tag-count?name=${encodeURIComponent(currentImageData.name)}&official=${currentImageData.isOfficial}`;
                console.log('Requesting tag count from:', countApiUrl);
                
                const countData = await fetchWithRetry(countApiUrl);
                console.log('Received tag count data:', countData);
                
                const tagCount = countData.count || 0;
                const recommendedMode = countData.recommended_mode || 'paginated';
                
                // 根据标签数量判断是否显示警告
                let warningMessage = '';
                let loadAllBtnDisabled = false;
                
                if (tagCount > 1000) {
                    warningMessage = `<div class="tag-count-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>该镜像包含 <strong>${tagCount}</strong> 个标签，加载全部可能会很慢。建议使用分页浏览或利用搜索功能查找特定标签。</p>
                    </div>`;
                    loadAllBtnDisabled = true;
                } else if (tagCount > 500) {
                    warningMessage = `<div class="tag-count-warning moderate">
                        <i class="fas fa-info-circle"></i>
                        <p>该镜像包含 <strong>${tagCount}</strong> 个标签，加载全部可能需要一些时间。</p>
                    </div>`;
                }
                
                // 重新构建标签视图内容
                imageTagsView.innerHTML = `
                    <div class="tag-header">
                        <div class="tag-breadcrumb">
                            <a href="javascript:void(0);" onclick="showSearchResults()">返回搜索结果</a>
                        </div>
                        <h2 id="currentImageTitle">${imageName}</h2>
                        <p id="imageDescription" class="image-description">${currentImageData.description || '暂无描述'}</p>
                        <div class="image-meta">
                            <span id="imageStars"><i class="fas fa-star"></i> ${formatNumber(currentImageData.stars || 0)} 星标</span>
                            <span id="imagePulls"><i class="fas fa-download"></i> ${formatNumber(currentImageData.pulls || 0)} 下载</span>
                            <span id="imageTags"><i class="fas fa-tags"></i> ${formatNumber(tagCount)} 个标签</span>
                        </div>
                    </div>
                    
                    ${warningMessage}
                    
                    <div class="tag-actions">
                        <div class="tag-search-container">
                            <input type="text" id="tagSearchInput" placeholder="搜索TAG..." onkeyup="filterTags()">
                            <button class="search-btn" onclick="filterTags()">
                                <i class="fas fa-search"></i> 搜索
                            </button>
                        </div>
                        <button id="loadAllTagsBtn" class="load-all-btn" onclick="loadAllTags()" ${loadAllBtnDisabled ? 'disabled' : ''}>
                            <i class="fas fa-cloud-download-alt"></i> 加载全部TAG
                        </button>
                    </div>
                    
                    <div id="tagsResults"></div>
                    
                    <div class="pagination-container" id="tagPaginationContainer" style="display: none;">
                        <button id="tagPrevPageBtn" onclick="loadImageTags(currentTagPage - 1)" disabled>
                            <i class="fas fa-chevron-left"></i> 上一页
                        </button>
                        <span id="tagPageInfo">第 1 页</span>
                        <button id="tagNextPageBtn" onclick="loadImageTags(currentTagPage + 1)">
                            下一页 <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                `;
                
                // 加载标签列表
                currentTagPage = 1;
                await loadImageTags(1);
                enhanceTagSearchContainer();
                
            } catch (error) {
                console.error('Error loading image details:', error);
                imageTagsView.innerHTML = `
                    <div class="tag-header">
                        <div class="tag-breadcrumb">
                            <a href="javascript:void(0);" onclick="showSearchResults()">返回搜索结果</a>
                        </div>
                        <div class="error-message">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>加载镜像详情失败: ${error.message}</p>
                            <button onclick="viewImageDetails('${currentImageData.name}', ${currentImageData.isOfficial}, '${encodeURIComponent(currentImageData.description)}', ${currentImageData.stars}, ${currentImageData.pulls})" class="retry-btn">
                                <i class="fas fa-redo"></i> 重试
                            </button>
                        </div>
                    </div>
                `;
                
                // 显示通知
                showToast(`<i class="fas fa-exclamation-circle"></i> 加载镜像详情失败: ${error.message}`, true);
            }
        }

        // 添加formatNumber函数定义
        function formatNumber(num) {
            if (num >= 1000000000) {
                return (num >= 1500000000 ? '1B+' : '1B');
            } else if (num >= 1000000) {
                const m = Math.floor(num / 1000000);
                return (m >= 100 ? '100M+' : m + 'M');
            } else if (num >= 1000) {
                const k = Math.floor(num / 1000);
                return (k >= 100 ? '100K+' : k + 'K');
            }
            return num.toString();
        }

        // 新增: 加载所有标签 - 改进错误处理
        async function loadAllTags() {
            if (!currentImageData) {
                console.error('No image data available');
                return;
            }
            
            const loadAllTagsBtn = document.getElementById('loadAllTagsBtn');
            const tagsResults = document.getElementById('tagsResults');
            
            // 禁用按钮，显示加载状态
            loadAllTagsBtn.disabled = true;
            loadAllTagsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在加载全部TAG...';
            tagsResults.innerHTML = '<div class="loading-indicator">加载所有TAG中，这可能需要一些时间...</div>';
            
            try {
                // 先获取标签总数
                const countApiUrl = `/api/dockerhub/tag-count?name=${encodeURIComponent(currentImageData.name)}&official=${currentImageData.isOfficial}`;
                const countData = await fetchWithRetry(countApiUrl);
                
                const totalTags = countData.count || 0;
                
                if (totalTags === 0) {
                    tagsResults.innerHTML = '<div class="message-container"><i class="fas fa-info-circle"></i><p>未找到标签信息</p></div>';
                    showToast(`<i class="fas fa-info-circle"></i> 该镜像没有可用的标签`, false);
                    loadAllTagsBtn.disabled = false;
                    loadAllTagsBtn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> 加载全部TAG';
                    return;
                }
                
                // 计算需要请求的次数 (每页最多100个标签)
                const pageSize = 100;
                const totalPages = Math.ceil(totalTags / pageSize);
                
                // 如果标签太多，提示用户
                if (totalTags > 3000) {
                    const confirmLoad = confirm(`该镜像包含 ${totalTags} 个标签，加载全部可能会很慢。确定继续吗？`);
                    if (!confirmLoad) {
                        loadAllTagsBtn.disabled = false;
                        loadAllTagsBtn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> 加载全部TAG';
                        tagsResults.innerHTML = '';
                        await loadImageTags(1); // 加载第一页
                        return;
                    }
                }
                
                // 所有标签的集合
                let allTags = [];
                let loadedPages = 0;
                
                // 更新加载进度的函数
                const updateProgress = () => {
                    loadAllTagsBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> 正在加载 (${Math.round((loadedPages/totalPages)*100)}%)`;
                    tagsResults.innerHTML = `<div class="loading-indicator">已加载 ${allTags.length} / ${totalTags} 个标签 (${Math.round((loadedPages/totalPages)*100)}%)...</div>`;
                };
                
                // 分批加载所有标签
                for (let page = 1; page <= totalPages; page++) {
                    try {
                        const apiUrl = `/api/dockerhub/tags?name=${encodeURIComponent(currentImageData.name)}&official=${currentImageData.isOfficial}&page=${page}&page_size=${pageSize}`;
                        
                        // 使用新的fetchWithRetry函数
                        const data = await fetchWithRetry(apiUrl);
                        
                        if (data.results && Array.isArray(data.results)) {
                            // 处理标签中缺少平台信息的情况
                            const processedTags = data.results.map(tag => {
                                if (!tag.images || !Array.isArray(tag.images) || tag.images.length === 0) {
                                    tag.images = [];
                                }
                                return tag;
                            });
                            
                            allTags = allTags.concat(processedTags);
                        }
                        
                        loadedPages++;
                        updateProgress();
                        
                    } catch (error) {
                        console.error(`加载第 ${page} 页标签出错:`, error);
                    }
                }
                
                if (allTags.length > 0) {
                    // 为加载的所有标签实现客户端分页
                    window.allLoadedTags = allTags; // 保存所有标签到全局变量
                    window.currentAllTagsPage = 1;
                    window.tagsPerPage = 25; // 修改: 每页显示25个标签而不是50个
                    
                    // 计算总页数
                    const clientTotalPages = Math.ceil(allTags.length / window.tagsPerPage);
                    
                    // 显示第一页标签（这会自动创建分页控制器）
                    displayAllTagsPage(1);
                    
                    // 显示提示
                    showToast(`<i class="fas fa-check-circle"></i> 成功加载 ${allTags.length} / ${totalTags} 个标签，分${clientTotalPages}页显示`, false);
                    
                    // 滚动到顶部
                    window.scrollTo({
                        top: document.getElementById('imageTagsView').offsetTop - 80,
                        behavior: 'smooth'
                    });
                    
                } else {
                    tagsResults.innerHTML = '<div class="message-container"><i class="fas fa-info-circle"></i><p>未找到标签信息</p></div>';
                    showToast(`<i class="fas fa-info-circle"></i> 未能加载标签`, true);
                }
                
            } catch (error) {
                console.error('加载全部标签失败:', error);
                tagsResults.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>加载全部标签失败: ${error.message}</p>
                        <button onclick="loadImageTags(1)" class="retry-btn">
                            <i class="fas fa-redo"></i> 返回常规模式
                        </button>
                    </div>
                `;
                showToast(`<i class="fas fa-exclamation-circle"></i> 加载全部标签失败: ${error.message}`, true);
            } finally {
                // 恢复按钮状态
                loadAllTagsBtn.disabled = false;
                loadAllTagsBtn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> 加载全部TAG';
            }
        }
        
        // 添加 loadImageTags 函数定义
        async function loadImageTags(page = 1) {
            if (!currentImageData) {
                console.error('No image data available');
                return;
            }
            const tagsResults = document.getElementById('tagsResults');
            tagsResults.innerHTML = '<div class="loading-indicator">加载TAG列表中...</div>';
            
            try {
                // 构建API URL
                const apiUrl = `/api/dockerhub/tags?name=${encodeURIComponent(currentImageData.name)}&official=${currentImageData.isOfficial}&page=${page}&page_size=25`;
                console.log('Requesting tags from:', apiUrl);
                
                // 使用fetchWithRetry获取数据
                const data = await fetchWithRetry(apiUrl);
                console.log('Received tags data:', data);
                currentTagPage = page; // 更新当前页码
                
                if (data.results && data.results.length > 0) {
                    // 处理标签中缺少平台信息的情况
                    const processedTags = data.results.map(tag => {
                        // 确保tag.images存在
                        if (!tag.images || !Array.isArray(tag.images) || tag.images.length === 0) {
                            tag.images = [];
                        }
                        return tag;
                    });
                    
                    // 显示标签列表
                    displayTags(processedTags);
                    
                    // 更新分页信息
                    updateTagPagination(page, Math.ceil((data.count || 0) / 25));
                    document.getElementById('tagPaginationContainer').style.display = 'flex';
                    
                    // 更新页面显示信息
                    const tagStatsDiv = document.querySelector('.tag-search-stats');
                    if (tagStatsDiv) {
                        tagStatsDiv.innerHTML = `<p>共找到 <strong>${data.count || processedTags.length}</strong> 个标签，当前显示第 <strong>${(page-1)*25+1}</strong> 至 <strong>${Math.min(page*25, data.count)}</strong> 个</p>`;
                    }
                    
                } else {
                    tagsResults.innerHTML = '<div class="message-container"><i class="fas fa-info-circle"></i><p>未找到标签信息</p></div>';
                    document.getElementById('tagPaginationContainer').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading tags:', error);
                tagsResults.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>加载标签失败: ${error.message}</p>
                        <button onclick="loadImageTags(${page})" class="retry-btn">
                            <i class="fas fa-redo"></i> 重试
                        </button>
                    </div>
                `;
                document.getElementById('tagPaginationContainer').style.display = 'none';
                
                // 显示通知
                showToast(`<i class="fas fa-exclamation-circle"></i> 加载标签失败: ${error.message}`, true);
            }
        }

        // 新增: 显示客户端分页控制器
        function displayClientPagination(totalPages) {
            const tagsResults = document.getElementById('tagsResults');
            
            // 创建分页容器
            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination-container'; // 使用相同的样式类名
            paginationDiv.id = 'clientPaginationContainer';
            
            // 添加分页控制，格式与默认分页控制器相同
            paginationDiv.innerHTML = `
                <button id="clientPrevPageBtn" onclick="navigateAllTagsPage(-1)" disabled>
                    <i class="fas fa-chevron-left"></i> 上一页
                </button>
                <span id="clientPageInfo">第 1 页 / 共 ${totalPages} 页</span>
                <button id="clientNextPageBtn" onclick="navigateAllTagsPage(1)" ${totalPages <= 1 ? 'disabled' : ''}>
                    下一页 <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            // 确保分页控制器添加到表格底部
            const existingPagination = document.getElementById('tagPaginationContainer');
            if (existingPagination && existingPagination.parentNode) {
                // 在原始分页控制器的位置插入新的分页控制器
                existingPagination.parentNode.insertBefore(paginationDiv, existingPagination);
                // 隐藏原来的分页控件
                existingPagination.style.display = 'none';
            } else {
                // 如果找不到原始分页控制器，添加到结果容器末尾
                tagsResults.appendChild(paginationDiv);
            }
        }

        // 新增: 切换到指定页面
        function displayAllTagsPage(page) {
            if (!window.allLoadedTags) return;
            
            const totalTags = window.allLoadedTags.length;
            // 修改: 将每页标签数量从50改为25
            window.tagsPerPage = 25; // 每页显示25个标签
            const tagsPerPage = window.tagsPerPage;
            const totalPages = Math.ceil(totalTags / tagsPerPage);
            
            // 确保页码在有效范围内
            if (page < 1) page = 1;
            if (page > totalPages) page = totalPages;
            
            window.currentAllTagsPage = page;
            
            // 计算当前页的标签
            const startIndex = (page - 1) * tagsPerPage;
            const endIndex = Math.min(startIndex + tagsPerPage, totalTags);
            const currentPageTags = window.allLoadedTags.slice(startIndex, endIndex);
            
            // 使用现有的displayTags函数显示当前页的标签
            displayTags(currentPageTags);
            enhanceTagSearchContainer();
            
            // 更新分页信息
            const pageInfo = document.getElementById('clientPageInfo');
            if (pageInfo) {
                pageInfo.textContent = `第 ${page} 页 / 共 ${totalPages} 页`;
            }
            
            // 更新按钮状态
            const prevBtn = document.getElementById('clientPrevPageBtn');
            const nextBtn = document.getElementById('clientNextPageBtn');
            if (prevBtn) prevBtn.disabled = page <= 1;
            if (nextBtn) nextBtn.disabled = page >= totalPages;
            
            // 更新标签统计信息
            const tagStatsDiv = document.querySelector('.tag-search-stats');
            if (tagStatsDiv) {
                tagStatsDiv.innerHTML = `<p>显示 <strong>${startIndex + 1}-${endIndex}</strong> 个标签，共 <strong>${totalTags}</strong> 个</p>`;
            }
            
            // 创建新的客户端分页控制器
            const clientPaginationContainer = document.getElementById('clientPaginationContainer');
            if (!clientPaginationContainer) {
                displayClientPagination(totalPages);
            }
        }

        // 新增: 页面导航函数
        function navigateAllTagsPage(direction) {
            const newPage = window.currentAllTagsPage + direction;
            displayAllTagsPage(newPage);
            
            // 滚动到分页控制器位置，确保用户可以看到分页器
            const paginationContainer = document.getElementById('clientPaginationContainer');
            if (paginationContainer) {
                paginationContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // 显示TAG列表 - 改进默认排序和显示
        function displayTags(tags) {
            const tagsResults = document.getElementById('tagsResults');
            tagsResults.innerHTML = '';
            
            if (tags.length === 0) {
                tagsResults.innerHTML = '<div class="message-container">没有找到匹配的TAG</div>';
                return;
            }
            
            // 添加标签搜索统计信息
            const searchStatsDiv = document.createElement('div');
            searchStatsDiv.className = 'tag-search-stats';
            searchStatsDiv.innerHTML = `<p>共找到 <strong>${tags.length}</strong> 个标签</p>`;
            tagsResults.appendChild(searchStatsDiv);
            
            // 添加标签排序功能
            const sortContainer = document.createElement('div');
            sortContainer.className = 'tag-sort-container';
            sortContainer.innerHTML = `
                <label for="tagSort">排序方式:</label>
                <select id="tagSort" onchange="sortTags()">
                    <option value="name-asc">TAG名称 (A-Z)</option>
                    <option value="name-desc">TAG名称 (Z-A)</option>
                    <option value="date-desc" selected>最新更新</option>
                    <option value="date-asc">最早更新</option>
                    <option value="size-desc">大小 (大-小)</option>
                    <option value="size-asc">大小 (小-大)</option>
                </select>
            `;
            tagsResults.appendChild(sortContainer);
            
            // 创建表格容器以启用水平滚动
            const tableContainer = document.createElement('div');
            tableContainer.className = 'tag-table-container';
            tagsResults.appendChild(tableContainer);
            
            const tagTable = document.createElement('table');
            tagTable.className = 'tag-table';
            tagTable.id = 'tagTable';
            
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th width="18%">TAG</th>
                    <th width="42%">OS/ARCH</th>
                    <th width="15%">大小</th>
                    <th width="15%">更新时间</th>
                    <th width="10%">操作</th>
                </tr>
            `;
            tagTable.appendChild(thead);
            
            const tbody = document.createElement('tbody');
            tbody.id = 'tagTableBody';
            
            // 使用最新更新的默认排序
            window.currentTags = [...tags];
            sortTagsByDate('desc');
                
            renderTagRows(window.currentTags, tbody);
            
            tagTable.appendChild(tbody);
            tableContainer.appendChild(tagTable); // 将表格添加到容器中
            
            // 添加调试信息
            console.log(`显示了 ${tags.length} 个标签`);
        }

        // 新增的排序标签函数
        function sortTags() {
            const sortSelect = document.getElementById('tagSort');
            const [sortBy, direction] = sortSelect.value.split('-');
            
            if (sortBy === 'name') {
                sortTagsByName(direction);
            } else if (sortBy === 'date') {
                sortTagsByDate(direction);
            } else if (sortBy === 'size') {
                sortTagsBySize(direction);
            }
            
            const tbody = document.getElementById('tagTableBody');
            tbody.innerHTML = '';
            renderTagRows(window.currentTags, tbody);
        }
        
        // 按名称排序
        function sortTagsByName(direction) {
            window.currentTags.sort((a, b) => {
                return direction === 'asc' 
                    ? a.name.localeCompare(b.name) 
                    : b.name.localeCompare(a.name);
            });
        }
        
        // 按日期排序
        function sortTagsByDate(direction) {
            window.currentTags.sort((a, b) => {
                const dateA = a.last_updated ? new Date(a.last_updated) : new Date(0);
                const dateB = b.last_updated ? new Date(b.last_updated) : new Date(0);
                return direction === 'asc' ? dateA - dateB : dateB - dateA;
            });
        }
        
        // 按大小排序
        function sortTagsBySize(direction) {
            window.currentTags.sort((a, b) => {
                const sizeA = a.full_size || 0;
                const sizeB = b.full_size || 0;
                return direction === 'asc' ? sizeA - sizeB : sizeB - sizeA;
            });
        }
        
        // 渲染标签行
        function renderTagRows(tags, tbody) {
            tags.forEach((tag, index) => {
                const tr = document.createElement('tr');
                 
                // 计算大小
                let size = '未知';
                if (tag.full_size) {
                    const sizeInMB = Math.round(tag.full_size / 1024 / 1024);
                    size = `${sizeInMB} MB`;
                }
                   
                // 格式化日期
                let lastUpdated = '未知';
                if (tag.last_updated) {
                    const date = new Date(tag.last_updated);
                    lastUpdated = date.toLocaleDateString('zh-CN');
                }
                
                tr.innerHTML = `
                    <td>${tag.name}</td>
                    <td>${createOsArchHtml(tag.images, index)}</td>
                    <td>${size}</td>
                    <td>${lastUpdated}</td>
                    <td>
                        <button class="primary-btn" onclick="useImage('${currentImageData.name}:${tag.name}')">
                            <i class="fas fa-rocket"></i> 使用
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function createOsArchHtml(images, tagIndex) {
            // 确保images是有效数据
            if (!images || !Array.isArray(images) || images.length === 0) {
                return '<div class="tag-os-arch"><span class="tag-os-arch-item">无平台信息</span></div>';
            }
            
            // 过滤和去重平台信息，过滤掉unknown/unknown
            const uniquePlatforms = [];
            const seen = new Set();
            images.forEach(img => {
                if (img && img.os && img.architecture) {
                    // 跳过unknown/unknown组合
                    if (img.os === 'unknown' && img.architecture === 'unknown') {
                        return;
                    }
                    
                    const key = `${img.os}/${img.architecture}${img.variant ? '/' + img.variant : ''}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        uniquePlatforms.push(img);
                    }
                }
            });
            
            if (uniquePlatforms.length === 0) {
                return '<div class="tag-os-arch"><span class="tag-os-arch-item">无平台信息</span></div>';
            }
            
            // 改进的显示逻辑：以列表形式显示所有平台
            const mainPlatforms = uniquePlatforms.slice(0, 4); // 显示前4个
            const extraPlatforms = uniquePlatforms.slice(4);   // 其余隐藏
                        
            let html = '<div class="tag-os-arch">';
            
            // 显示主要平台
            mainPlatforms.forEach(img => {
                html += `<span class="tag-os-arch-item">${img.os}/${img.architecture}${img.variant ? '/' + img.variant : ''}</span>`;
            });
            
            // 如果有更多平台，添加展开功能
            if (extraPlatforms.length > 0) {
                html += `
                    <span class="tag-os-arch-more" onclick="toggleOsArch(${tagIndex})">
                        <i class="fas fa-plus-circle"></i> 显示更多(${extraPlatforms.length})
                    </span>
                    <div id="osArch${tagIndex}" class="tag-os-arch-all">
                `;
                
                extraPlatforms.forEach(img => {
                    html += `<span class="tag-os-arch-item">${img.os}/${img.architecture}${img.variant ? '/' + img.variant : ''}</span>`;
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }

        function toggleOsArch(tagIndex) {
            const element = document.getElementById(`osArch${tagIndex}`);
            element.classList.toggle('show');
            const moreBtn = element.previousElementSibling;
            
            if (element.classList.contains('show')) {
                moreBtn.innerHTML = '<i class="fas fa-minus-circle"></i> 收起';
            } else {
                moreBtn.innerHTML = `<i class="fas fa-plus-circle"></i> 显示更多(${element.children.length})`;
            }
        }

        // 修改TAG过滤功能 - 支持搜索所有已加载的标签
        function filterTags() {
            const searchTerm = document.getElementById('tagSearchInput').value.toLowerCase().trim();
            
            // 检查是否已加载全部标签
            if (window.allLoadedTags && searchTerm) {
                // 在所有加载的标签中搜索
                const matchedTags = window.allLoadedTags.filter(tag => 
                    tag.name.toLowerCase().includes(searchTerm)
                );
                
                // 更新搜索统计信息
                const searchStatsDiv = document.querySelector('.tag-search-stats');
                if (searchStatsDiv) {
                    searchStatsDiv.innerHTML = `<p>过滤结果: 共找到 <strong>${matchedTags.length}</strong> 个匹配 "${searchTerm}" 的标签 (共${window.allLoadedTags.length}个)</p>`;
                }
                
                // 如果有匹配的标签
                if (matchedTags.length > 0) {
                    // 显示匹配的标签
                    displayTags(matchedTags);
                    
                    // 隐藏分页控件，显示所有匹配结果
                    const clientPagination = document.getElementById('clientPaginationContainer');
                    if (clientPagination) {
                        clientPagination.style.display = 'none';
                    }
                } else {
                    // 无匹配结果提示
                    const tagsResults = document.getElementById('tagsResults');
                    // 保留搜索统计信息
                    const statsHTML = tagsResults.innerHTML.split('</div>')[0] + '</div>';
                    tagsResults.innerHTML = statsHTML + '<div class="no-filter-results"><p>没有匹配 "' + searchTerm + '" 的TAG</p></div>';
                }
                
                return; // 已处理全局搜索，不继续执行
            }
            
            // 原有的过滤逻辑 - 只搜索当前页面上的标签
            const rows = document.querySelectorAll('.tag-table tbody tr');
            if (!rows.length) return;
            
            let visibleCount = 0;
            rows.forEach(row => {
                const tagName = row.querySelector('td:first-child').textContent.toLowerCase();
                if (tagName.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // 更新过滤后的统计信息
            const searchStatsDiv = document.querySelector('.tag-search-stats');
            if (searchStatsDiv) {
                if (searchTerm) {
                    searchStatsDiv.innerHTML = `<p>过滤结果: 共找到 <strong>${visibleCount}</strong> 个匹配 "${searchTerm}" 的标签</p>`;
                } else {
                    searchStatsDiv.innerHTML = `<p>共找到 <strong>${rows.length}</strong> 个标签</p>`;
                }
            }
            
            // 如果没有匹配的结果，显示提示
            const tagsResults = document.getElementById('tagsResults');
            const noResultsEl = tagsResults.querySelector('.no-filter-results');
            
            if (visibleCount === 0 && searchTerm) {
                if (!noResultsEl) {
                    const message = document.createElement('div');
                    message.className = 'no-filter-results';
                    message.innerHTML = `<p>没有匹配 "${searchTerm}" 的TAG</p>`;
                    tagsResults.appendChild(message);
                }
            } else if (noResultsEl) {
                noResultsEl.remove();
            }
        }

        // 添加重置搜索功能
        function resetTagSearch() {
            const searchInput = document.getElementById('tagSearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            
            // 如果已加载全部标签，重新显示当前页
            if (window.allLoadedTags) {
                displayAllTagsPage(window.currentAllTagsPage || 1);
                // 恢复分页控件显示
                const clientPagination = document.getElementById('clientPaginationContainer');
                if (clientPagination) {
                    clientPagination.style.display = 'flex';
                }
            } else {
                // 否则重新加载当前标签页
                loadImageTags(currentTagPage);
            }
        }

        // 修改标签搜索容器，添加重置按钮
        function enhanceTagSearchContainer() {
            const container = document.querySelector('.tag-search-container');
            if (container) {
                // 检查是否已经增强过
                if (!container.querySelector('.reset-btn')) {
                    // 添加重置按钮
                    const resetBtn = document.createElement('button');
                    resetBtn.className = 'reset-btn';
                    resetBtn.innerHTML = '<i class="fas fa-times"></i> 重置';
                    resetBtn.onclick = resetTagSearch;
                    container.appendChild(resetBtn);
                    
                    // 修改搜索按钮点击事件
                    const searchBtn = container.querySelector('.search-btn');
                    if (searchBtn) {
                        searchBtn.onclick = filterTags;
                    }
                }
            }
        }

        // 获取文档列表
        async function fetchDocumentation() {
            const documentList = document.getElementById('documentList');
            const documentationText = document.getElementById('documentationText');
            
            documentList.innerHTML = '<h2>文档列表</h2>';
            const ul = document.createElement('ul');
            
            mockDocuments.forEach(doc => {
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.href = 'javascript:void(0);';
                link.textContent = doc.title;
                link.onclick = () => {
                    document.querySelectorAll('#documentList a').forEach(a => a.classList.remove('active'));
                    link.classList.add('active');
                    showDocument(doc.id);
                };
                li.appendChild(link);
                ul.appendChild(li);
            });

            documentList.appendChild(ul);
            
            // 默认显示第一篇文档
            if(mockDocuments[0]) {
                const firstLink = ul.querySelector('a');
                if(firstLink) {
                    firstLink.classList.add('active');
                    showDocument(mockDocuments[0].id);
                }
            }
        }

        // 修改showDocument函数使用mock数据
        function showDocument(id) {
            const doc = mockDocuments.find(d => d.id === id);
            const documentationText = document.getElementById('documentationText');
            
            if(doc) {
                documentationText.innerHTML = `<h2>${doc.title}</h2>${marked.parse(doc.content)}`;
                // 为所有代码块添加复制按钮和终端样式
                const codeBlocks = documentationText.querySelectorAll('pre code');
                codeBlocks.forEach((codeBlock) => {
                    const pre = codeBlock.parentElement;
                    const code = codeBlock.textContent;
                    
                    // 创建终端风格容器
                    const wrapper = document.createElement('div');
                    wrapper.className = 'command-terminal';
                    wrapper.innerHTML = `
                        <div class="terminal-header">
                            <div class="terminal-button button-red"></div>
                            <div class="terminal-button button-yellow"></div>
                            <div class="terminal-button button-green"></div>
                        </div>
                    `;
                    
                    // 创建复制按钮
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-btn';
                    copyButton.textContent = '复制';
                    copyButton.onclick = () => copyToClipboard(code, copyButton);
                    
                    // 正确的DOM操作顺序
                    pre.parentNode.insertBefore(wrapper, pre);  // 1. 先将wrapper插入到pre前面
                    wrapper.appendChild(pre);                   // 2. 将pre移动到wrapper内
                    pre.appendChild(copyButton);                // 3. 将复制按钮添加到pre内
                });
            } else {
                documentationText.innerHTML = '未找到文档';
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 设置当前年份
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // 加载菜单项
            const navMenu = document.getElementById('navMenu');
            config.menuItems.forEach(item => {
                const a = document.createElement('a');
                a.href = item.link;
                a.textContent = item.text;
                if(item.newTab) {
                    a.target = '_blank';
                }
                navMenu.appendChild(a);
            });
        });

        function useImage(imageName) {
            if (imageName) {
                console.log("使用镜像:", imageName);
                document.getElementById('imageInput').value = imageName;
                switchTab('accelerate');
                // 直接生成加速命令，无需用户再次点击
                generateCommands(imageName);
            } else {
                alert('无效的 Docker 镜像名称');
            }
        }

        // 改进Toast通知功能，支持HTML内容
        function showToast(message, isError = false) {
            // 移除任何现有的提示
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());
            
            // 创建新的提示
            const toast = document.createElement('div');
            toast.className = `toast-notification ${isError ? 'error' : 'info'}`;
            toast.innerHTML = message; // 使用innerHTML而不是textContent以支持HTML
            document.body.appendChild(toast);
            
            // 3秒后自动消失
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 5000); // 延长显示时间到5秒，给用户更多时间阅读
        }

        // 添加缺失的showSearchResults函数
        function showSearchResults() {
            // 显示搜索结果列表，隐藏标签视图
            document.getElementById('searchResultsList').style.display = 'block';
            document.getElementById('imageTagsView').style.display = 'none';
            
            // 清空标签搜索输入框
            const tagSearchInput = document.getElementById('tagSearchInput');
            if (tagSearchInput) {
                tagSearchInput.value = '';
            }
            
            // 显示分页控件（如果有搜索结果）
            if (document.getElementById('searchResults').children.length > 0) {
                document.getElementById('paginationContainer').style.display = 'flex';
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.0.3/marked.min.js"></script>
</body>
</html>
